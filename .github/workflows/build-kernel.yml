name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      enable_feature_kpm:
        description: "Enable KPM feature"
        required: false
        default: false
        type: boolean
      enable_feature_lxc:
        description: "Enable LXC feature"
        required: false
        default: false
        type: boolean
      SOURCECODE_BRANCH:
        description: 'Kernel source branch'
        required: true
        default: 'U-dev'

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Kernel for MTK 4.14
    strategy:
      fail-fast: false
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_DIR: /home/runner/.ccache
      CCACHE_MAXSIZE: 8G
      LLVM: "1"
      ARCH: "arm64"
      CROSS_COMPILE: "aarch64-linux-gnu-"
      CROSS_COMPILE_ARM32: "arm-linux-gnueabi-"
      CC: "clang"
      LD: "ld.lld"
      HOSTLD: "ld.lld"
      O: "out"
      KCFLAGS: "-O2"

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Install packages
        run: |
          sudo apt update
          sudo apt install -y git ccache p7zip-full wget

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: /home/runner/.ccache
          key: ccache-${{ runner.os }}-${{ github.ref }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - uses: actions/checkout@v5

      - name: Get Kernel Source
        uses: actions/checkout@v5
        with:
          repository: MerCuJerry/android_kernel_aresin
          ref: ${{ inputs.SOURCECODE_BRANCH }}
          path: kernel

      # ========== SETUP CLANG 23 (Mandi-Sa) ==========
      - name: Download Clang 23
        run: |
          mkdir -p clang
          wget -q https://github.com/Mandi-Sa/clang/releases/download/amd64-kernel-arm_static-23/llvm23.0.0-binutils2.45.1_amd64-kernel-arm_static-20260118.7z
          # فك الضغط باستخدام 7z لأن الملف بصيغة .7z
          7z x llvm23.0.0-binutils2.45.1_amd64-kernel-arm_static-20260118.7z -oclang/
          rm llvm23.0.0-binutils2.45.1_amd64-kernel-arm_static-20260118.7z

      - name: Copy defconfig
        run: |
          # التأكد من وجود مجلد Patches
          mkdir -p Patches
          touch Patches/ares_user_defconfig_append

          # إضافة KPM إذا فعّل المستخدم
          if [ "${{ inputs.enable_feature_kpm }}" = "true" ]; then
            echo "CONFIG_KALLSYMS_ALL=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_KPM=y" >> Patches/ares_user_defconfig_append
          fi

          # إضافة دعم LXC إذا فعّل المستخدم
          if [ "${{ inputs.enable_feature_lxc }}" = "true" ]; then
            echo "CONFIG_NAMESPACES=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_CGROUPS=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_CGROUP_CPUACCT=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_CGROUP_DEVICE=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_CGROUP_SCHED=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_CGROUP_FREEZER=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_CGROUP_PIDS=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_MEMCG=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_LXC=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_KPM=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_SYSVIPC=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_PID_NS=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_UTS_NS=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_MNT_NS=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_IPC_NS=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_DEVTMPFS=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_KALLSYMS=y" >> Patches/ares_user_defconfig_append
            echo "CONFIG_KALLSYMS_ALL=y" >> Patches/ares_user_defconfig_append
          fi

          # دمج defconfig النهائي
          cat Patches/ares_user_defconfig_append >> kernel/arch/arm64/configs/ares_user_defconfig

      - name: Build Kernel
        working-directory: kernel
        run: |
          export KBUILD_BUILD_TIMESTAMP=$(date)
          export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
          make -j$(nproc --all) ares_user_defconfig all

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: MTK_Kernel_Image
          path: kernel/out/arch/arm64/boot/Image
          compression-level: 9

      - name: Upload DTB
        uses: actions/upload-artifact@v4
        with:
          name: MTK_Kernel_DTB
          path: kernel/out/arch/arm64/boot/dtb
          compression-level: 9
