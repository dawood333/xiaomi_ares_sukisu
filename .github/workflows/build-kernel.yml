name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      SOURCECODE_BRANCH:
        description: '源码分支名称 or Revision'
        required: true
        default: 'lineage-23.1'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_DIR: /home/runner/.ccache
      CCACHE_MAXSIZE: 8G
    strategy:
      fail-fast: false
    name: Build Kernel for K40GE
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Install Package
        run: sudo apt update && sudo apt install -y p7zip-full git ccache curl tar xz-utils zstd libarchive-tools

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: /home/runner/.ccache
          key: ccache-${{ runner.os }}-${{ github.ref }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - uses: actions/checkout@v5

      - name: Get Kernel Source Code
        uses: actions/checkout@v5
        with:
          repository: Eron-Evan/android_kernel_xiaomi_mt6893
          ref: ${{ inputs.SOURCECODE_BRANCH }}
          path: kernel
      
      - name: Setup Latest Neutron Clang
        run: |
          mkdir -p neutron-clang
          curl -LSs "https://raw.githubusercontent.com/Neutron-Toolchains/antman/main/antman" > antman
          chmod +x antman
          ./antman -S
          # إضافة المسار بشكل إجباري في مقدمة النظام
          echo "$GITHUB_WORKSPACE/neutron-clang/bin" >> $GITHUB_PATH

      - name: Build Kernel
        working-directory: kernel
        run: |
          # تعريف المسارات محلياً لضمان الأولوية القصوى لـ Neutron
          export PATH=$GITHUB_WORKSPACE/neutron-clang/bin:$PATH
          export KBUILD_BUILD_TIMESTAMP=$(date)
          
          # التحقق من أن المترجم الصحيح هو الذي يعمل (يجب أن يظهر Neutron)
          clang --version
          
          # تعريف المتغيرات مباشرة داخل الأمر لتجنب مشاكل Kbuild
          MAKE_ARGS="ARCH=arm64 \
                     LLVM=1 \
                     LLVM_IAS=1 \
                     CROSS_COMPILE=aarch64-linux-gnu- \
                     CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
                     O=out \
                     KCFLAGS=-w \
                     HOSTCFLAGS=-w \
                     HOSTCXXFLAGS=-w"

          # 1. إعداد الإعدادات الافتراضية
          make -j$(nproc --all) $MAKE_ARGS ares_defconfig
          
          # 2. تفعيل LTO
          scripts/config --file out/.config -e LTO_CLANG -e LTO_CLANG_THIN
          
          # 3. البناء النهائي (إزالة W=0 لتجنب الخطأ)
          make -j$(nproc --all) $MAKE_ARGS all
      
      - name: Upload Kernel Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-K40GE-Neutron-LTO-${{ inputs.SOURCECODE_BRANCH }}
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/out/arch/arm64/boot/Image.gz
            kernel/out/arch/arm64/boot/Image.gz-dtb
            kernel/out/arch/arm64/boot/dts/mediatek/ares.dtb
          if-no-files-found: warn
